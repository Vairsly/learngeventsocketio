<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>What is gevent? &mdash; PyconSG 2013 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PyconSG 2013 0.1.0 documentation" href="index.html" />
    <link rel="next" title="What are threads?" href="threads.html" />
    <link rel="prev" title="Welcome to PyconSG 2013’s documentation!" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="threads.html" title="What are threads?"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to PyconSG 2013’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyconSG 2013 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="what-is-gevent">
<h1>What is gevent?<a class="headerlink" href="#what-is-gevent" title="Permalink to this headline">¶</a></h1>
<p>Gevent is the use of simple, sequential programming in python to achieve scalability provided by asynchronous IO and lightweight multi-threading (as opposed to the callback-style of programming using Twisted&#8217;s Deferred).</p>
<p>It is built on top of libevent/libev (for asynchronous I/O) and <a class="reference internal" href="greenlets.html"><em>greenlets</em></a> (lightweight cooperative multi-threading).</p>
<p>Pre-1.0 version, gevent is based on <a class="reference external" href="http://libevent.org">libevent</a>; and from 1.0 onwards, gevent is based on <a class="reference external" href="http://libev.schmorp.de">libev</a>.</p>
<p>Once we understand what each of the building blocks of gevent do -</p>
<ul class="simple">
<li><a class="reference internal" href="#libevent-label"><em>libevent</em></a>,</li>
<li><a class="reference internal" href="#libev-label"><em>libev</em></a> and</li>
<li><a class="reference internal" href="#greenlets-label"><em>greenlets</em></a></li>
</ul>
<p>we will have a clear idea of what it means to implement gevent in our python projects.</p>
<div class="section" id="libevent-label">
<span id="id1"></span><h2>libevent<a class="headerlink" href="#libevent-label" title="Permalink to this headline">¶</a></h2>
<p>Written in C, this library provides asynchronous event notification.  The libevent API provides a mechanism to execute a callback function when a specific event occurs on a file descriptor or after a timeout has been reached. It also supports callbacks triggered by signals and regular timeouts.</p>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>/dev/poll</li>
<li>kqueue</li>
<li>select</li>
<li>poll</li>
<li>epoll</li>
<li>Solaris&#8217; event ports</li>
<li>experimental support for real-time signals</li>
</ul>
</div>
<div class="section" id="notable-applications-that-use-libevent">
<h3>Notable Applications that use libevent<a class="headerlink" href="#notable-applications-that-use-libevent" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Chrome web browser (linux and mac version)</li>
<li>Memcached</li>
<li>tmux</li>
<li>tor</li>
</ul>
<p>etc etc</p>
</div>
</div>
<div class="section" id="libev-label">
<span id="id2"></span><h2>libev<a class="headerlink" href="#libev-label" title="Permalink to this headline">¶</a></h2>
<p>A forked version of libevent with a view to improve on some (problematic) architectural decisions made in libevent, for instance:</p>
<ul class="simple">
<li>the global variable usage in libevent made it hard to use libevent safely in multithreaded environments.</li>
<li>watcher structures are big because they combine I/O, time and signal handlers in one</li>
<li>extra components such as the http and dns servers may not be implemented well, resulting in security issues</li>
</ul>
<p>libev attempts to resolve some of these problems by not using global variables and use a loop context for all functions.  The http and dns related components were completely removed and focuses on doing only one specific thing - POSIX event library</p>
<p>gevent 1.0 onwards has been refactored to use libev instead of libevent.  Details of the rationale for this decision is <a class="reference external" href="http://blog.gevent.org/2011/04/28/libev-and-libevent/">explained by gevent author Denis Bilenko</a>.</p>
<p>The <a class="reference external" href="http://c-ares.haxx.se/">c-ares</a> library is used to replace libevent-dns since libev does not handle http and dns functionality as explained above.</p>
<div class="section" id="id3">
<h3>Implementation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Exactly the same as libevent&#8217;s</p>
<ul class="simple">
<li>/dev/poll</li>
<li>kqueue</li>
<li>select</li>
<li>poll</li>
<li>epoll</li>
<li>Solaris&#8217; event ports</li>
<li>experimental support for real-time signals</li>
</ul>
<p>libevent has better windows-support implementation since libevent accepts windows handles while libev needs to convert windows handles into C runtime handles.</p>
</div>
</div>
<div class="section" id="greenlets">
<span id="greenlets-label"></span><h2>greenlets<a class="headerlink" href="#greenlets" title="Permalink to this headline">¶</a></h2>
<p>Greenlets are a lightweight cooperative threads - which is different from our conventional understanding of POSIX threads (pthreads).</p>
<p>It is a spin-off of Stackless, a version of CPython which supports microthreads called &#8220;tasklets&#8221;.  Tasklets (Stackless) run pseudo-concurrently (in a single or a few OS-level threads) and are synchronized with data exchanged in &#8220;channels&#8221;.  Greenlet is more primitive compared to these &#8220;tasklet&#8221; microthreads and is more accurately described as a &#8220;coroutines&#8221; - cooperative routines. Meaning that greenlets has no implicit scheduling like &#8220;tasklets&#8221; and we can control exactly when our code runs.</p>
<p>The greenlet source code can be found <a class="reference external" href="https://github.com/python-greenlet/greenlet">here</a> and is provided as a C extension module for python.</p>
<p>We dive into further details about greenlets <a class="reference internal" href="greenlets.html"><em>here</em></a>.</p>
</div>
<div class="section" id="gevent-api-design">
<h2>gevent API design<a class="headerlink" href="#gevent-api-design" title="Permalink to this headline">¶</a></h2>
<p>gevent&#8217;s interface follows the conventions set by python standard modules</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/surfly/gevent/blob/master/gevent/event.py">gevent.event.Event</a> has the same interface and the same semantics as python&#8217;s built-in modules threading.Event and multiprocessing.Event.</li>
<li>wait() does not raise an exception</li>
<li>get() can raise an exception or return a value</li>
<li>join() is like wait() but for units of execution</li>
</ul>
<p>Having consistent code interfaces like these helps programmers read and reason with the code in a much more efficient manner.</p>
</div>
<div class="section" id="gevent-with-other-python-extensions">
<h2>gevent with other python extensions<a class="headerlink" href="#gevent-with-other-python-extensions" title="Permalink to this headline">¶</a></h2>
<p>If some kind of transaction involves I/O, the greenlet might get switched away waiting for a write-acknowledgement (or other kinds of I/O block), we have to explicitly lock the transaction. If our code ever gets back to the old blocking I/O style, our entire application will fail.  To prevent this from happening, only use extensions that make use of the built-in python socket module.</p>
</div>
<div class="section" id="gevent-s-monkey-patch">
<h2>gevent&#8217;s monkey patch<a class="headerlink" href="#gevent-s-monkey-patch" title="Permalink to this headline">¶</a></h2>
<p>A monkey patch is a way to extend or modify the run-time code of dynamic languages without altering the original source code.  Monkey patching as a programming technique is very powerful but can result in hard-to-debug code in the wrong hands.  Jeff Atwood wrote a good post about these issues here - <a class="reference external" href="http://www.codinghorror.com/blog/2008/07/monkeypatching-for-humans.html">http://www.codinghorror.com/blog/2008/07/monkeypatching-for-humans.html</a>.</p>
<blockquote>
<div><p>Monkey patching is the new black [in the Ruby community]. It&#8217;s what all the hip kids are doing. To the point that smart, experienced hackers reach for a monkey patch as their tool of first resort, even when a simpler, more traditional solution is possible.</p>
<p>I don&#8217;t believe this situation to be sustainable. Where I work, we are already seeing subtle, difficult-to-debug problems crop up as the result of monkey patching in plugins. Patches interact in unpredictable, combinatoric ways. And by their nature, bugs caused by monkey patches are more difficult to track down than those introduced by more traditional classes and methods. As just one example: on one project, it was a known caveat that we could not rely on class inheritable attributes as provided by ActiveSupport. No one knew why. Every Model we wrote had to use awkward workarounds. Eventually we tracked it down in a plugin that generated admin consoles. It was overwriting Class.inherited(). It took us months to find this out.</p>
<p>This is just going to get worse if we don&#8217;t do something about it. And the &#8220;something&#8221; is going to have to be a cultural shift, not a technical fix. I believe it is time for experienced Ruby programmers to wean ourselves off of monkey patching, and start demonstrating more robust techniques.</p>
</div></blockquote>
<p>Whenever we decide to use a library which uses a monkey patch approach, it is important that we read the source code and documentation fully and understand how that library&#8217;s monkey patch affects our standard source code, modules and libraries.</p>
<p>One of gevent&#8217;s most important features is monkey patching, so we will need to understand what monkey patching actually does - <a class="reference external" href="http://www.gevent.org/gevent.monkey.html">http://www.gevent.org/gevent.monkey.html</a></p>
<blockquote>
<div><p>The functions in this module patch parts of the standard library with compatible cooperative counterparts from gevent package.</p>
<p>To patch an individual module call the corresponding patch_* function. For example, to patch socket module only, call patch_socket(). To patch all default modules, call gevent.monkey.patch_all().</p>
<p>Monkey can also patch thread and threading to become greenlet-based. So thread.start_new_thread() starts a new greenlet instead and threading.local becomes a greenlet-local storage.</p>
</div></blockquote>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>This works:-</p>
<blockquote>
<div><div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">gevent.monkey</span><span class="p">;</span> <span class="n">gevent</span><span class="o">.</span><span class="n">monkey</span><span class="o">.</span><span class="n">patch_thread</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">threading</span>
</pre></div>
</div>
</div></blockquote>
<p>This explodes (try it):-</p>
<blockquote>
<div><div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">gevent.monkey</span><span class="p">;</span> <span class="n">gevent</span><span class="o">.</span><span class="n">monkey</span><span class="o">.</span><span class="n">patch_thread</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>When the threading module is imported, it uses the main thread ID as a key in a module-level thread dictionary.  When the program exits, the threading module tries to obtain the thread instance from the dictionary (using the current thread ID) to perform clean up.</p>
<p>However, because of <cite>gevent.monkey.patch_thread()</cite>, the ID of the main thread is no longer the same!  Stackoverflow question and answer here with all the <a class="reference external" href="http://stackoverflow.com/questions/8774958/keyerror-in-module-threading-after-a-successful-py-test-run/12639040#12639040">gory details</a>.</p>
<p>Long story short, the <cite>order in which we monkey patch gevent is important</cite>.  Always execute the monkey patch first before running your python code, particularly if your code uses threading at some point.  Note that the <cite>logging</cite> module also uses <cite>threading</cite> so when <cite>logging</cite> your application, monkey patch first!</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">What is gevent?</a><ul>
<li><a class="reference internal" href="#libevent-label">libevent</a><ul>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#notable-applications-that-use-libevent">Notable Applications that use libevent</a></li>
</ul>
</li>
<li><a class="reference internal" href="#libev-label">libev</a><ul>
<li><a class="reference internal" href="#id3">Implementation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#greenlets">greenlets</a></li>
<li><a class="reference internal" href="#gevent-api-design">gevent API design</a></li>
<li><a class="reference internal" href="#gevent-with-other-python-extensions">gevent with other python extensions</a></li>
<li><a class="reference internal" href="#gevent-s-monkey-patch">gevent&#8217;s monkey patch</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to PyconSG 2013&#8217;s documentation!</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="threads.html"
                        title="next chapter">What are threads?</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/gevent.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="threads.html" title="What are threads?"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to PyconSG 2013’s documentation!"
             >previous</a> |</li>
        <li><a href="index.html">PyconSG 2013 0.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Calvin Cheng.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>